# .github/workflows/cmake-pipeline.yml
name: CMake CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    tags: ['v*.*.*']
  pull_request:
    branches: [main]

env:
  BUILD_TYPE: Release
  C_COMPILER: gcc

jobs:
  # Job 1: 代码质量检查
  code-quality:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Check for required files
      run: |
        if [ ! -f "main.c" ]; then
          echo "❌ Error: main.c not found!"
          exit 1
        fi
        if [ ! -f "CMakeLists.txt" ]; then
          echo "❌ Error: CMakeLists.txt not found!"
          exit 1
        fi
        echo "✅ Required files found"
        ls -la
    
    - name: Format check
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format
        echo "Checking code formatting..."
        find . -name "*.c" -o -name "*.h" | xargs clang-format --dry-run --Werror
    
    - name: Static analysis
      run: |
        sudo apt-get install -y cppcheck
        echo "Running cppcheck..."
        cppcheck --enable=all --suppress=missingIncludeSystem \
                 --error-exitcode=1 --std=c11 main.c

  # Job 2: 构建测试（多平台/多编译器）
  build-and-test:
    runs-on: ${{ matrix.os }}
    needs: code-quality
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        compiler: [gcc, clang]
        build_type: [Debug, Release]
        exclude:
          - os: macos-latest
            compiler: gcc
        include:
          - os: windows-latest
            compiler: msvc
            build_type: Release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up environment
      run: |
        echo "OS: ${{ runner.os }}"
        echo "Compiler: ${{ matrix.compiler }}"
        echo "Build type: ${{ matrix.build_type }}"
    
    - name: Install dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build
        if [ "${{ matrix.compiler }}" = "clang" ]; then
          sudo apt-get install -y clang
        fi
    
    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew update
        brew install cmake ninja
    
    - name: Install dependencies (Windows)
      if: runner.os == 'Windows'
      run: |
        choco install cmake ninja
    
    - name: Configure CMake
      shell: bash
      run: |
        mkdir -p build
        cd build
        
        if [ "${{ runner.os }}" = "Windows" ]; then
          # Windows 配置
          cmake .. \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -G "Ninja"
        else
          # Linux/macOS 配置
          cmake .. \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DCMAKE_C_COMPILER=${{ matrix.compiler }} \
            -G "Ninja"
        fi
    
    - name: Build project
      shell: bash
      run: |
        cd build
        cmake --build . --config ${{ matrix.build_type }}
    
    - name: List build artifacts
      run: |
        echo "Build directory contents:"
        ls -la build/
        if [ -f "build/myapp" ] || [ -f "build/myapp.exe" ]; then
          echo "✅ Executable found"
        else
          echo "❌ Executable not found!"
          exit 1
        fi
    
    - name: Run program
      shell: bash
      run: |
        cd build
        echo "Running program..."
        
        # 处理不同的可执行文件名
        if [ -f "myapp" ]; then
          EXECUTABLE="./myapp"
        elif [ -f "myapp.exe" ]; then
          EXECUTABLE="./myapp.exe"
        elif [ -f "Debug/myapp.exe" ]; then
          EXECUTABLE="./Debug/myapp.exe"
        elif [ -f "Release/myapp.exe" ]; then
          EXECUTABLE="./Release/myapp.exe"
        fi
        
        if [ -n "$EXECUTABLE" ]; then
          echo "Executing: $EXECUTABLE"
          
          # 第一次运行：无输入
          timeout 5s $EXECUTABLE || echo "Program finished"
          
          # 第二次运行：模拟输入（如果需要）
          echo -e "test\n123\n" | timeout 5s $EXECUTABLE || echo "Program with input finished"
          
          # 检查返回值
          echo "Exit code of last run: $?"
        else
          echo "❌ No executable found to run"
        fi

    - name: Memory check (Linux Debug only)
      if: runner.os == 'Linux' && matrix.build_type == 'Debug'
      run: |
        cd build
        sudo apt-get install -y valgrind
        echo "Running valgrind..."
        valgrind --leak-check=full \
                 --show-leak-kinds=all \
                 --track-origins=yes \
                 --error-exitcode=1 \
                 ./myapp 2>&1 | tail -50

  # Job 3: 代码覆盖率（仅 PR）
  coverage:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install coverage tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc \
          lcov \
          gcovr
    
    - name: Build with coverage
      run: |
        mkdir -p build-coverage
        cd build-coverage
        cmake .. \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_C_FLAGS="--coverage -fprofile-arcs -ftest-coverage" \
          -G "Ninja"
        cmake --build .
    
    - name: Run program for coverage
      run: |
        cd build-coverage
        ./myapp
    
    - name: Generate coverage report
      run: |
        cd build-coverage
        # 生成 lcov 报告
        lcov --capture --directory . --output-file coverage.info
        lcov --remove coverage.info '/usr/*' '*/test/*' --output-file coverage.filtered.info
        genhtml coverage.filtered.info --output-directory coverage-report
        
        # 生成 gcovr 报告
        gcovr --exclude-unreachable-branches --print-summary --xml coverage.xml --html coverage.html .
    
    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: |
          build-coverage/coverage-report/
          build-coverage/coverage.html
          build-coverage/coverage.xml

  # Job 4: 安全扫描
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install security tools
      run: |
        sudo apt-get update
        sudo apt-get install -y flawfinder
    
    - name: Run flawfinder
      run: |
        echo "=== Security Scan with Flawfinder ==="
        flawfinder --quiet --minlevel=3 main.c
    
    - name: Basic security checks
      run: |
        echo "=== Checking for common issues ==="
        
        # 检查不安全的函数
        echo "1. Checking for unsafe functions:"
        grep -n "gets\|strcpy\|strcat\|sprintf\|scanf" main.c || echo "No unsafe functions found"
        
        # 检查缓冲区操作
        echo -e "\n2. Checking buffer operations:"
        grep -n "memcpy\|memmove\|strncpy" main.c || echo "No buffer operations found"
        
        # 检查指针操作
        echo -e "\n3. Checking pointer operations:"
        grep -n "\*\|->\|malloc\|free" main.c || echo "No pointer operations found"

  # Job 5: 二进制分析
  binary-analysis:
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: Checkout and build
      uses: actions/checkout@v4
    
    - name: Build for analysis
      run: |
        mkdir -p build-analysis
        cd build-analysis
        cmake .. -DCMAKE_BUILD_TYPE=Release -G "Ninja"
        cmake --build .
    
    - name: Analyze binary
      run: |
        cd build-analysis
        if [ -f "myapp" ]; then
          echo "=== Binary Analysis ==="
          
          # 文件信息
          echo "1. File information:"
          file myapp
          
          # 大小信息
          echo -e "\n2. Size information:"
          size myapp
          
          # 符号表
          echo -e "\n3. Symbol table (first 20):"
          nm myapp | head -20
          
          # 依赖库
          echo -e "\n4. Library dependencies:"
          ldd myapp 2>/dev/null || echo "Not a dynamic executable"
          
          # 段信息
          echo -e "\n5. Section sizes:"
          readelf -S myapp | grep -E "(Name|\.text|\.data|\.rodata|\.bss)"
          
          # 安全检查
          echo -e "\n6. Security checks:"
          checksec --file=myapp 2>/dev/null || echo "checksec not available"
        fi

  # Job 6: 打包和发布（仅标签）
  package-and-release:
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Get version from tag
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Package version: $VERSION"
    
    - name: Build release
      run: |
        mkdir -p build-release
        cd build-release
        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_C_FLAGS="-O3 -march=native -s" \
          -G "Ninja"
        cmake --build .
        
        # 验证构建
        ./myapp --version 2>/dev/null || ./myapp -v 2>/dev/null || echo "Running program..."
        timeout 2s ./myapp || echo "Program executed"
    
    - name: Create packages
      run: |
        cd build-release
        
        # 使用 CPack 创建包
        cpack
        
        # 同时创建简单压缩包
        mkdir -p dist
        cp myapp dist/
        cd dist
        
        # 创建不同格式的包
        tar czf myapp-v${{ steps.get_version.outputs.VERSION }}-linux-x64.tar.gz myapp
        zip myapp-v${{ steps.get_version.outputs.VERSION }}-linux-x64.zip myapp
        
        # 计算哈希值
        sha256sum myapp-v${{ steps.get_version.outputs.VERSION }}-linux-x64.tar.gz > SHA256SUMS
        sha256sum myapp-v${{ steps.get_version.outputs.VERSION }}-linux-x64.zip >> SHA256SUMS
        
        echo "Created packages:"
        ls -lh *.tar.gz *.zip
    
    - name: Upload release artifacts
      uses: softprops/action-gh-release@v1
      with:
        files: |
          build-release/*.tar.gz
          build-release/*.zip
          build-release/dist/*.tar.gz
          build-release/dist/*.zip
          build-release/dist/SHA256SUMS
        draft: false
        prerelease: false

  # Job 7: 部署到测试环境（示例）
  deploy-test:
    runs-on: ubuntu-latest
    needs: package-and-release
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: myapp-package
        path: ./artifacts
    
    - name: Extract and deploy
      run: |
        echo "=== Deploying to test environment ==="
        
        # 这里添加你的部署逻辑
        # 例如：复制到测试服务器、重启服务等
        
        echo "1. Listing artifacts:"
        ls -la artifacts/
        
        echo -e "\n2. Simulating deployment..."
        echo "Would deploy myapp to test server"
        
        # 实际部署示例（需要配置 secrets）：
        # scp artifacts/myapp user@test-server:/opt/myapp/
        # ssh user@test-server "systemctl restart myapp"
    
    - name: Smoke test
      run: |
        echo "=== Running smoke test ==="
        echo "Testing if deployment was successful..."
        
        # 这里添加你的冒烟测试逻辑
        # 例如：检查服务是否运行、API 是否响应等
        
        echo "Smoke test passed!"

# 缓存配置（可选的性能优化）
# 在全局或作业中添加：
#   - name: Cache CMake
#     uses: actions/cache@v3
#     with:
#       path: |
#         ~/.cache/ccache
#         build/CMakeCache.txt
#         build/CMakeFiles
#       key: ${{ runner.os }}-cmake-${{ hashFiles('CMakeLists.txt') }}
